FROM node:22-slim AS base

# –≠—Ç–∞–ø —Å–±–æ—Ä–∫–∏
FROM base AS builder

RUN npm install -g pnpm
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
RUN mkdir -p "$PNPM_HOME"

RUN pnpm add -g turbo

WORKDIR /app
COPY . .
RUN turbo prune web --docker

# –≠—Ç–∞–ø —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ —Å–±–æ—Ä–∫–∏
FROM base AS installer

# ‚ö†Ô∏è –í–ê–ñ–ù–û: —Å–Ω–æ–≤–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º pnpm –∑–¥–µ—Å—å!
RUN npm install -g pnpm
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
RUN mkdir -p "$PNPM_HOME"

# turbo –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –Ω–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ, –µ—Å–ª–∏ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—à—å turbo run
# RUN pnpm add -g turbo

WORKDIR /app

COPY --from=builder /app/out/json/ .
# –ö–æ–ø–∏—Ä—É–µ–º pnpm-lock.yaml –∏–∑ out/json (–∞ –Ω–µ –∏–∑ /app/)
COPY --from=builder /app/out/json/pnpm-lock.yaml ./
# üîë –ö–û–ü–ò–†–£–ï–ú –ö–û–†–ù–ï–í–û–ô package.json ‚Äî —ç—Ç–æ –≤–∞–∂–Ω–æ!
COPY --from=builder /app/package.json ./
RUN pnpm install

COPY --from=builder /app/out/full/ .
RUN pnpm turbo run build

# –§–∏–Ω–∞–ª—å–Ω—ã–π —ç—Ç–∞–ø ‚Äî –∑–∞–ø—É—Å–∫
FROM base AS runner
WORKDIR /app

RUN addgroup --system --gid 1001 nextjs && \
    adduser --system --uid 1001 --gid 1001 nextjs

USER nextjs
COPY --from=installer --chown=nextjs:nextjs /app/apps/web/.next/standalone ./
COPY --from=installer --chown=nextjs:nextjs /app/apps/web/.next/static ./apps/web/.next/static
COPY --from=installer --chown=nextjs:nextjs /app/apps/web/public ./apps/web/public

CMD ["node", "apps/web/server.js"]
